---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Comments from '../../components/Comments.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import '../../styles/blog.css';

/* =========================
   정적 경로 생성
========================= */
export async function getStaticPaths() {
  const posts = (await getCollection('blog'))
    .filter(p => !p.data.draft)
    .sort(
      (a, b) =>
        (a.data.pubDate?.getTime() ?? 0) -
        (b.data.pubDate?.getTime() ?? 0)
    );

  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

/* =========================
   페이지 렌더링
========================= */
const { post } = Astro.props;

/* 이전 / 다음 글 계산 */
const allPosts = (await getCollection('blog'))
  .filter(p => !p.data.draft)
  .sort(
    (a, b) =>
      (a.data.pubDate?.getTime() ?? 0) -
      (b.data.pubDate?.getTime() ?? 0)
  );

const index = allPosts.findIndex(p => p.slug === post.slug);
const prev = index > 0 ? allPosts[index - 1] : null;
const next = index < allPosts.length - 1 ? allPosts[index + 1] : null;

/* 본문 렌더 */
const rendered = await render(post);
const { Content, html } = rendered;

/* 대표 이미지 (첫 img) */
const heroMatch =
  typeof html === 'string'
    ? html.match(/<img[^>]+src="([^">]+)"/)
    : null;

const heroImage = heroMatch ? heroMatch[1] : null;
const publishedDate = post.data.pubDate?.toLocaleDateString() ?? '';
---

<BaseLayout title={`${post.data.title} | 조용한 세계문학 서재`}>
  <article class="post-article">

    {heroImage && (
      <div class="post-hero">
        <img src={heroImage} alt={post.data.title} />
      </div>
    )}

    <header class="post-header">
      <h1>{post.data.title}</h1>
      <time>{publishedDate}</time>
    </header>

    <section class="post-content">
      <Content />
    </section>

    <PostNavigation prev={prev} next={next} />

    <Comments />

  </article>
</BaseLayout>
