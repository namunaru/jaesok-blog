---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Comments from '../../components/Comments.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import '../../styles/blog.css';

import {
  getPublishedPosts,
  getPostBySlug,
  renderNotionContent,
} from '../../lib/notion';

/* =========================
   정적 경로 생성 (Notion)
========================= */
export async function getStaticPaths() {
  const posts = await getPublishedPosts();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { slug: post.slug },
  }));
}

/* =========================
   페이지 렌더링
========================= */
const { slug } = Astro.props;

/* 현재 글 */
const post = await getPostBySlug(slug);
if (!post) {
  throw new Error(`Post not found: ${slug}`);
}

/* 전체 글 (이전 / 다음 계산용) */
const allPosts = await getPublishedPosts();
const index = allPosts.findIndex((p) => p.slug === slug);
const prev = index > 0 ? allPosts[index - 1] : null;
const next = index < allPosts.length - 1 ? allPosts[index + 1] : null;

/* 노션 본문 렌더 */
const contentHtml = await renderNotionContent(post.pageId);

/* 대표 이미지 */
const heroImage = post.cover ?? null;
const publishedDate = post.date ?? '';
---

<BaseLayout title={`${post.title} | 조용한 세계문학 서재`}>
  <article class="post-article">

    {heroImage && (
      <div class="post-hero">
        <img src={heroImage} alt={post.title} />
      </div>
    )}

    <header class="post-header">
      <h1>{post.title}</h1>
      <time>{publishedDate}</time>
    </header>

    <section class="post-content">
      <Fragment set:html={contentHtml} />
    </section>

    <PostNavigation prev={prev} next={next} />

    <Comments />

  </article>
</BaseLayout>
