---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Comments from '../../components/Comments.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import '../../styles/blog.css';

/* ✅ 정적 경로 생성 (반드시 내부에서 호출) */
export async function getStaticPaths() {
  const posts = (await getCollection('blog'))
    .filter(p => !p.data.draft)
    .sort(
      (a, b) =>
        (a.data.pubDate?.getTime() ?? 0) -
        (b.data.pubDate?.getTime() ?? 0)
    );

  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

/* ✅ 여기부터는 페이지 렌더링 영역 */
const { post } = Astro.props;

/* 전체 글 목록 (이전/다음용) */
const allPosts = (await getCollection('blog'))
  .filter(p => !p.data.draft)
  .sort(
    (a, b) =>
      (a.data.pubDate?.getTime() ?? 0) -
      (b.data.pubDate?.getTime() ?? 0)
  );

const index = allPosts.findIndex(p => p.slug === post.slug);
const prev = index > 0 ? allPosts[index - 1] : null;
const next = index < allPosts.length - 1 ? allPosts[index + 1] : null;

/* 본문 렌더 */
const rendered = await render(post);
const Content = rendered.Content;
const html = typeof rendered.html === 'string' ? rendered.html : '';

/* 대표 이미지 (첫 img) */
const heroMatch = html.match(/<img[^>]+src="([^">]+)"/);
const heroImage = heroMatch ? heroMatch[1] : null;

const publishedDate = post.data.pubDate?.toLocaleDateString() ?? '';
---

<BaseLayout title={`${post.data.title} | 조용한 세계문학 서재`}>
  <article class="post-article">

    {heroImage && (
      <div class="post-hero">
        <img src={heroImage} alt={post.data.title} />
      </div>
    )}

    <header class="post-header">
      <h1>{post.data.title}</h1>
      <time>{publishedDate}</time>
    </header>

    <section class="post-content">
      <Content />
    </section>

    <PostNavigation prev={prev} next={next} />
    <Comments />

  </article>
</BaseLayout>
