---
import { getEntry, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const { slug } = Astro.params;
const video = await getEntry('video', slug);

if (!video) return Astro.redirect('/404');
const { Content } = await render(video);

// YouTube ID를 안전하게 추출하는 함수
function getYouTubeId(url: string) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[7].length == 11) ? match[7] : null;
}

const videoId = getYouTubeId(video.data.youtube);
---

<BaseLayout title={`${video.data.title} | 영상리뷰`}>
  <article class="reading-room container">
    <header class="post-header">
      <span class="category">영상리뷰</span>
      <h1 class="serif">{video.data.title}</h1>
      <time>{video.data.pubDate?.toLocaleDateString('ko-KR')}</time>
    </header>

    <div class="video-section">
      {videoId ? (
        <div class="video-container">
          <iframe 
            src={`https://www.youtube.com/embed/${videoId}`} 
            title="YouTube video player" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
          </iframe>
        </div>
      ) : (
        <div class="error-msg">영상 주소가 올바르지 않습니다.</div>
      )}
    </div>

    <div class="prose serif">
      <Content />
    </div>
  </article>
</BaseLayout>

<style>
  .reading-room { padding: 80px 20px; max-width: 850px; }
  .post-header { text-align: center; margin-bottom: 50px; }
  .category { color: var(--accent); font-size: 0.9rem; letter-spacing: 0.1em; display: block; margin-bottom: 15px; }
  .post-header h1 { font-size: 2.5rem; line-height: 1.3; margin-bottom: 15px; }
  .post-header time { color: #999; font-size: 0.95rem; }
  
  .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
  .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  
  .prose { margin-top: 60px; font-size: 1.15rem; line-height: 2.1; color: #333; }
  .error-msg { padding: 50px; background: #eee; text-align: center; border-radius: 12px; }
</style>