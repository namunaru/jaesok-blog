---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getPublishedPosts, mapNotionPageToSchema } from '../lib/notion/posts';

const videoEntries = await getCollection('video');
const latestVideos = videoEntries.sort((a, b) => (b.data.pubDate?.valueOf() ?? 0) - (a.data.pubDate?.valueOf() ?? 0)).slice(0, 3);

let latestReviews = [];
try {
  const rawPosts = await getPublishedPosts();
  latestReviews = (rawPosts || []).map(mapNotionPageToSchema).slice(0, 3);
} catch (e) { console.error(e); }
---

<BaseLayout title="홈 | 조용한 세계문학 서재">
  <section class="hero">
    <h1 class="serif">안녕하세요, gedsc입니다</h1>
    <p>이곳은 세계문학을 읽고, 그 내용을 요약하고 해석하며<br/>개인적인 감상과 사유를 기록하는 공간입니다.</p>
  </section>

  <div class="archive-container">
    <section class="list-section">
      <h2 class="serif">최근 기록 · 글</h2>
      <div class="post-list">
        {latestReviews.length > 0 ? latestReviews.map(post => (
          <a href={`/review/${post.id}`} class="post-item">
            <span class="title">{post.title}</span>
            <span class="date">{post.pubDate.toLocaleDateString('en-US')}</span>
          </a>
        )) : <p class="empty">기록된 글이 없습니다. (배포 후 확인)</p>}
      </div>
    </section>

    <section class="list-section">
      <h2 class="serif">최근 기록 · 영상</h2>
      <div class="post-list">
        {latestVideos.map(v => (
          <a href={`/video/${v.id.replace('.md', '')}`} class="post-item">
            <span class="title">▶ {v.data.title}</span>
            <span class="date">{v.data.pubDate?.toLocaleDateString('en-US')}</span>
          </a>
        ))}
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .hero { text-align: center; padding: 100px 20px; }
  .archive-container { max-width: 720px; margin: 0 auto; padding-bottom: 100px; }
  .list-section { margin-top: 60px; }
  .list-section h2 { text-align: center; font-size: 1.4rem; margin-bottom: 30px; }
  .post-item { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid rgba(0,0,0,0.05); text-decoration: none; color: inherit; }
  .date { color: #ccc; font-size: 0.85rem; }
</style>